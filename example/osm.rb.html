<html><style> a {color:#777; text-decoration:none;}
a.ten {color:#BBB; text-decoration:none;}
a:hover {color:#CBC}
body { background-color:#000; color:#BAB; background: linear-gradient(90deg, #030303 0%, #080808 50%, #030303 100%);}
.comment { color: green !important }
.string { color: gray; font-style: italic; }</style><body><table><tr><td><pre><a href='#'><b>1</b></a>
<a href='#'><b>2</b></a>
<a href='#'><b>3</b></a>
<a href='#'><b>4</b></a>
<a href='#'><b>5</b></a>
<a href='#'><b>6</b></a>
<a href='#'><b>7</b></a>
<a href='#'><b>8</b></a>
<a href='#'><b>9</b></a>
<a href='#'><b>10</b></a>
<a href='#'><b>11</b></a>
<a href='#'><b>12</b></a>
<a href='#'><b>13</b></a>
<a href='#'><b>14</b></a>
<a href='#'><b>15</b></a>
<a href='#'><b>16</b></a>
<a href='#'><b>17</b></a>
<a href='#'><b>18</b></a>
<a href='#'><b>19</b></a>
<a href='#'><b>20</b></a>
<a href='#'><b>21</b></a>
<a href='#'><b>22</b></a>
<a href='#'><b>23</b></a>
<a href='#'><b>24</b></a>
<a href='#'><b>25</b></a>
<a href='#'><b>26</b></a>
<a href='#'><b>27</b></a>
<a href='#'><b>28</b></a>
<a href='#'><b>29</b></a>
<a href='#'><b>30</b></a>
<a href='#'><b>31</b></a>
<a href='#'><b>32</b></a>
<a href='#'><b>33</b></a>
<a href='#'><b>34</b></a>
<a href='#'><b>35</b></a>
<a href='#'><b>36</b></a>
<a href='#'><b>37</b></a>
<a href='#'><b>38</b></a>
<a href='#'><b>39</b></a>
<a href='#'><b>40</b></a>
<a href='#'><b>41</b></a>
<a href='#'><b>42</b></a>
<a href='#'><b>43</b></a>
<a href='#'><b>44</b></a>
<a href='#'><b>45</b></a>
<a href='#'><b>46</b></a>
<a href='#'><b>47</b></a>
<a href='#'><b>48</b></a>
<a href='#'><b>49</b></a>
<a href='#'><b>50</b></a>
<a href='#'><b>51</b></a>
<a href='#'><b>52</b></a>
<a href='#'><b>53</b></a>
<a href='#'><b>54</b></a>
<a href='#'><b>55</b></a>
<a href='#'><b>56</b></a>
<a href='#'><b>57</b></a>
<a href='#'><b>58</b></a>
<a href='#'><b>59</b></a>
<a href='#'><b>60</b></a>
<a href='#'><b>61</b></a>
<a href='#'><b>62</b></a>
<a href='#'><b>63</b></a>
<a href='#'><b>64</b></a>
<a href='#'><b>65</b></a>
<a href='#'><b>66</b></a>
<a href='#'><b>67</b></a>
<a href='#'><b>68</b></a>
<a href='#'><b>69</b></a>
<a href='#'><b>70</b></a>
<a href='#'><b>71</b></a>
<a href='#'><b>72</b></a>
<a href='#'><b>73</b></a>
<a href='#'><b>74</b></a>
<a href='#'><b>75</b></a>
<a href='#'><b>76</b></a>
<a href='#'><b>77</b></a>
<a href='#'><b>78</b></a>
<a href='#'><b>79</b></a>
<a href='#'><b>80</b></a>
<a href='#'><b>81</b></a>
<a href='#'><b>82</b></a>
<a href='#'><b>83</b></a>
<a href='#'><b>84</b></a>
<a href='#'><b>85</b></a>
<a href='#'><b>86</b></a>
<a href='#'><b>87</b></a>
<a href='#'><b>88</b></a>
<a href='#'><b>89</b></a>
<a href='#'><b>90</b></a>
<a href='#'><b>91</b></a>
<a href='#'><b>92</b></a>
<a href='#'><b>93</b></a>
<a href='#'><b>94</b></a>
<a href='#'><b>95</b></a>
<a href='#'><b>96</b></a>
<a href='#'><b>97</b></a>
<a href='#'><b>98</b></a>
<a href='#'><b>99</b></a>
<a href='#'><b>100</b></a>
<a href='#'><b>101</b></a>
<a href='#'><b>102</b></a>
<a href='#'><b>103</b></a>
<a href='#'><b>104</b></a>
<a href='#'><b>105</b></a>
<a href='#'><b>106</b></a>
<a href='#'><b>107</b></a>
<a href='#'><b>108</b></a>
<a href='#'><b>109</b></a>
<a href='#'><b>110</b></a>
<a href='#'><b>111</b></a>
<a href='#'><b>112</b></a>
<a href='#'><b>113</b></a>
<a href='#'><b>114</b></a>
<a href='#'><b>115</b></a>
<a href='#'><b>116</b></a>
<a href='#'><b>117</b></a>
<a href='#'><b>118</b></a>
<a href='#'><b>119</b></a>
<a href='#'><b>120</b></a>
<a href='#'><b>121</b></a>
<a href='#'><b>122</b></a>
<a href='#'><b>123</b></a>
<a href='#'><b>124</b></a>
<a href='#'><b>125</b></a>
<a href='#'><b>126</b></a>
<a href='#'><b>127</b></a>
<a href='#'><b>128</b></a>
<a href='#'><b>129</b></a>
<a href='#'><b>130</b></a>
<a href='#'><b>131</b></a>
<a href='#'><b>132</b></a>
<a href='#'><b>133</b></a>
<a href='#'><b>134</b></a>
<a href='#'><b>135</b></a>
<a href='#'><b>136</b></a>
<a href='#'><b>137</b></a>
<a href='#'><b>138</b></a>
<a href='#'><b>139</b></a>
<a href='#'><b>140</b></a>
<a href='#'><b>141</b></a>
<a href='#'><b>142</b></a>
<a href='#'><b>143</b></a>
<a href='#'><b>144</b></a>
<a href='#'><b>145</b></a>
<a href='#'><b>146</b></a>
<a href='#'><b>147</b></a>
<a href='#'><b>148</b></a>
<a href='#'><b>149</b></a>
<a href='#'><b>150</b></a>
<a href='#'><b>151</b></a>
<a href='#'><b>152</b></a>
<a href='#'><b>153</b></a>
<a href='#'><b>154</b></a>
<a href='#'><b>155</b></a>
<a href='#'><b>156</b></a>
<a href='#'><b>157</b></a>
<a href='#'><b>158</b></a>
<a href='#'><b>159</b></a>
<a href='#'><b>160</b></a>
<a href='#'><b>161</b></a>
<a href='#'><b>162</b></a>
<a href='#'><b>163</b></a>
<a href='#'><b>164</b></a>
<a href='#'><b>165</b></a>
<a href='#'><b>166</b></a>
<a href='#'><b>167</b></a>
<a href='#'><b>168</b></a>
<a href='#'><b>169</b></a>
<a href='#'><b>170</b></a>
<a href='#'><b>171</b></a>
<a href='#'><b>172</b></a>
<a href='#'><b>173</b></a>
<a href='#'><b>174</b></a>
<a href='#'><b>175</b></a>
<a href='#'><b>176</b></a>
<a href='#'><b>177</b></a>
<a href='#'><b>178</b></a>
<a href='#'><b>179</b></a>
<a href='#'><b>180</b></a>
<a href='#'><b>181</b></a>
<a href='#'><b>182</b></a>
<a href='#'><b>183</b></a>
<a href='#'><b>184</b></a>
<a href='#'><b>185</b></a>
<a href='#'><b>186</b></a>
<a href='#'><b>187</b></a>
<a href='#'><b>188</b></a>
<a href='#'><b>189</b></a>
<a href='#'><b>190</b></a>
<a href='#'><b>191</b></a>
<a href='#'><b>192</b></a>
<a href='#'><b>193</b></a>
<a href='#'><b>194</b></a>
<a href='#'><b>195</b></a>
<a href='#'><b>196</b></a>
<a href='#'><b>197</b></a>
<a href='#'><b>198</b></a>
<a href='#'><b>199</b></a>
<a href='#'><b>200</b></a>
<a href='#'><b>201</b></a>
<a href='#'><b>202</b></a>
<a href='#'><b>203</b></a>
<a href='#'><b>204</b></a>
<a href='#'><b>205</b></a>
<a href='#'><b>206</b></a>
<a href='#'><b>207</b></a>
<a href='#'><b>208</b></a>
<a href='#'><b>209</b></a>
<a href='#'><b>210</b></a>
<a href='#'><b>211</b></a>
<a href='#'><b>212</b></a>
<a href='#'><b>213</b></a>
<a href='#'><b>214</b></a>
<a href='#'><b>215</b></a>
<a href='#'><b>216</b></a>
<a href='#'><b>217</b></a>
<a href='#'><b>218</b></a>
<a href='#'><b>219</b></a>
<a href='#'><b>220</b></a>
<a href='#'><b>221</b></a>
<a href='#'><b>222</b></a>
<a href='#'><b>223</b></a>
<a href='#'><b>224</b></a>
<a href='#'><b>225</b></a>
<a href='#'><b>226</b></a>
<a href='#'><b>227</b></a>
<a href='#'><b>228</b></a>
<a href='#'><b>229</b></a>
<a href='#'><b>230</b></a>
<a href='#'><b>231</b></a>
<a href='#'><b>232</b></a>
<a href='#'><b>233</b></a>
<a href='#'><b>234</b></a>
<a href='#'><b>235</b></a>
<a href='#'><b>236</b></a>
<a href='#'><b>237</b></a>
<a href='#'><b>238</b></a>
<a href='#'><b>239</b></a>
<a href='#'><b>240</b></a>
<a href='#'><b>241</b></a>
<a href='#'><b>242</b></a>
<a href='#'><b>243</b></a>
<a href='#'><b>244</b></a>
<a href='#'><b>245</b></a>
<a href='#'><b>246</b></a>
<a href='#'><b>247</b></a>
<a href='#'><b>248</b></a>
<a href='#'><b>249</b></a>
<a href='#'><b>250</b></a>
<a href='#'><b>251</b></a>
<a href='#'><b>252</b></a>
<a href='#'><b>253</b></a>
<a href='#'><b>254</b></a>
<a href='#'><b>255</b></a>
<a href='#'><b>256</b></a>
<a href='#'><b>257</b></a>
<a href='#'><b>258</b></a>
<a href='#'><b>259</b></a>
<a href='#'><b>260</b></a>
<a href='#'><b>261</b></a>
<a href='#'><b>262</b></a>
<a href='#'><b>263</b></a>
<a href='#'><b>264</b></a>
<a href='#'><b>265</b></a>
<a href='#'><b>266</b></a>
<a href='#'><b>267</b></a>
<a href='#'><b>268</b></a>
<a href='#'><b>269</b></a>
<a href='#'><b>270</b></a>
<a href='#'><b>271</b></a>
<a href='#'><b>272</b></a>
<a href='#'><b>273</b></a>
<a href='#'><b>274</b></a>
<a href='#'><b>275</b></a>
<a href='#'><b>276</b></a>
<a href='#'><b>277</b></a>
<a href='#'><b>278</b></a>
<a href='#'><b>279</b></a>
<a href='#'><b>280</b></a>
<a href='#'><b>281</b></a>
<a href='#'><b>282</b></a>
<a href='#'><b>283</b></a>
<a href='#'><b>284</b></a>
<a href='#'><b>285</b></a>
<a href='#'><b>286</b></a>
<a href='#'><b>287</b></a>
<a href='#'><b>288</b></a>
<a href='#'><b>289</b></a>
<a href='#'><b>290</b></a>
<a href='#'><b>291</b></a>
<a href='#'><b>292</b></a>
<a href='#'><b>293</b></a>
<a href='#'><b>294</b></a>
<a href='#'><b>295</b></a>
<a href='#'><b>296</b></a>
<a href='#'><b>297</b></a>
<a href='#'><b>298</b></a>
<a href='#'><b>299</b></a>
<a href='#'><b>300</b></a>
<a href='#'><b>301</b></a>
<a href='#'><b>302</b></a>
<a href='#'><b>303</b></a>
<a href='#'><b>304</b></a>
<a href='#'><b>305</b></a>
<a href='#'><b>306</b></a>
<a href='#'><b>307</b></a>
<a href='#'><b>308</b></a>
<a href='#'><b>309</b></a>
<a href='#'><b>310</b></a>
<a href='#'><b>311</b></a>
<a href='#'><b>312</b></a>
<a href='#'><b>313</b></a>
<a href='#'><b>314</b></a>
<a href='#'><b>315</b></a>
<a href='#'><b>316</b></a>
<a href='#'><b>317</b></a>
<a href='#'><b>318</b></a>
<a href='#'><b>319</b></a>
<a href='#'><b>320</b></a>
<a href='#'><b>321</b></a>
<a href='#'><b>322</b></a>
<a href='#'><b>323</b></a>
<a href='#'><b>324</b></a>
<a href='#'><b>325</b></a>
<a href='#'><b>326</b></a>
<a href='#'><b>327</b></a>
<a href='#'><b>328</b></a>
<a href='#'><b>329</b></a>
<a href='#'><b>330</b></a>
<a href='#'><b>331</b></a>
<a href='#'><b>332</b></a>
<a href='#'><b>333</b></a>
<a href='#'><b>334</b></a>
<a href='#'><b>335</b></a>
<a href='#'><b>336</b></a>
<a href='#'><b>337</b></a>
<a href='#'><b>338</b></a>
<a href='#'><b>339</b></a>
<a href='#'><b>340</b></a>
<a href='#'><b>341</b></a>
<a href='#'><b>342</b></a>
<a href='#'><b>343</b></a>
<a href='#'><b>344</b></a>
<a href='#'><b>345</b></a>
<a href='#'><b>346</b></a>
<a href='#'><b>347</b></a>
<a href='#'><b>348</b></a>
<a href='#'><b>349</b></a>
<a href='#'><b>350</b></a>
<a href='#'><b>351</b></a>
<a href='#'><b>352</b></a>
<a href='#'><b>353</b></a>
<a href='#'><b>354</b></a>
<a href='#'><b>355</b></a>
<a href='#'><b>356</b></a>
<a href='#'><b>357</b></a>
<a href='#'><b>358</b></a>
<a href='#'><b>359</b></a>
<a href='#'><b>360</b></a>
<a href='#'><b>361</b></a>
<a href='#'><b>362</b></a>
<a href='#'><b>363</b></a>
<a href='#'><b>364</b></a>
<a href='#'><b>365</b></a>
<a href='#'><b>366</b></a>
<a href='#'><b>367</b></a>
<a href='#'><b>368</b></a>
<a href='#'><b>369</b></a>
<a href='#'><b>370</b></a>
<a href='#'><b>371</b></a>
<a href='#'><b>372</b></a>
<a href='#'><b>373</b></a>
<a href='#'><b>374</b></a>
<a href='#'><b>375</b></a>
<a href='#'><b>376</b></a>
<a href='#'><b>377</b></a>
<a href='#'><b>378</b></a>
<a href='#'><b>379</b></a>
<a href='#'><b>380</b></a>
<a href='#'><b>381</b></a>
<a href='#'><b>382</b></a>
<a href='#'><b>383</b></a>
<a href='#'><b>384</b></a>
<a href='#'><b>385</b></a>
<a href='#'><b>386</b></a>
<a href='#'><b>387</b></a>
<a href='#'><b>388</b></a>
<a href='#'><b>389</b></a>
<a href='#'><b>390</b></a>
<a href='#'><b>391</b></a>
<a href='#'><b>392</b></a>
<a href='#'><b>393</b></a>
<a href='#'><b>394</b></a>
<a href='#'><b>395</b></a>
<a href='#'><b>396</b></a>
<a href='#'><b>397</b></a>
<a href='#'><b>398</b></a>
<a href='#'><b>399</b></a>
<a href='#'><b>400</b></a>
<a href='#'><b>401</b></a>
<a href='#'><b>402</b></a>
<a href='#'><b>403</b></a>
<a href='#'><b>404</b></a>
<a href='#'><b>405</b></a>
<a href='#'><b>406</b></a>
<a href='#'><b>407</b></a>
<a href='#'><b>408</b></a>
<a href='#'><b>409</b></a>
<a href='#'><b>410</b></a>
<a href='#'><b>411</b></a>
<a href='#'><b>412</b></a>
<a href='#'><b>413</b></a>
<a href='#'><b>414</b></a>
<a href='#'><b>415</b></a>
<a href='#'><b>416</b></a>
<a href='#'><b>417</b></a>
<a href='#'><b>418</b></a>
<a href='#'><b>419</b></a>
<a href='#'><b>420</b></a>
<a href='#'><b>421</b></a>
<a href='#'><b>422</b></a>
<a href='#'><b>423</b></a>
<a href='#'><b>424</b></a>
<a href='#'><b>425</b></a>
<a href='#'><b>426</b></a>
<a href='#'><b>427</b></a>
<a href='#'><b>428</b></a>
<a href='#'><b>429</b></a>
<a href='#'><b>430</b></a>
<a href='#'><b>431</b></a>
<a href='#'><b>432</b></a>
<a href='#'><b>433</b></a>
<a href='#'><b>434</b></a>
<a href='#'><b>435</b></a>
<a href='#'><b>436</b></a>
<a href='#'><b>437</b></a>
<a href='#'><b>438</b></a>
<a href='#'><b>439</b></a>
<a href='#'><b>440</b></a>
<a href='#'><b>441</b></a>
<a href='#'><b>442</b></a>
<a href='#'><b>443</b></a>
<a href='#'><b>444</b></a>
<a href='#'><b>445</b></a>
<a href='#'><b>446</b></a>
<a href='#'><b>447</b></a>
<a href='#'><b>448</b></a>
<a href='#'><b>449</b></a>
<a href='#'><b>450</b></a>
<a href='#'><b>451</b></a>
<a href='#'><b>452</b></a>
<a href='#'><b>453</b></a>
<a href='#'><b>454</b></a>
<a href='#'><b>455</b></a>
<a href='#'><b>456</b></a>
<a href='#'><b>457</b></a>
<a href='#'><b>458</b></a>
<a href='#'><b>459</b></a>
<a href='#'><b>460</b></a>
<a href='#'><b>461</b></a>
<a href='#'><b>462</b></a>
<a href='#'><b>463</b></a>
<a href='#'><b>464</b></a>
<a href='#'><b>465</b></a>
<a href='#'><b>466</b></a>
<a href='#'><b>467</b></a>
<a href='#'><b>468</b></a>
<a href='#'><b>469</b></a>
<a href='#'><b>470</b></a>
<a href='#'><b>471</b></a>
<a href='#'><b>472</b></a>
<a href='#'><b>473</b></a>
<a href='#'><b>474</b></a>
<a href='#'><b>475</b></a>
</pre></td><td><pre><span rel='t-916054410' style='color: #CABDA0' >class</span> <span rel='t686662836' style='color: #6CA5C7' >ApplicationController</span> &lt; <span rel='t1440711425' style='color: #C386D8' >ActionController</span>::<span rel='t1794695534' style='color: #8CA2ED' >Base</span>
  <span rel='t406251991' style='color: #E097B8' >include</span> <span rel='t-528584488' style='color: #EF8875' >SessionPersistence</span>

  <span rel='t1477592054' style='color: #9E8ED9' >protect_from_forgery</span>

  <span rel='t249264978' style='color: #E1EBD9' >before_filter</span> :<span rel='t-1967490055' style='color: #66D7CE' >fetch_body</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t388178347' style='color: #96917C' >authorize_web</span>
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t229118602' style='color: #B7979A' >session</span>[:<span rel='t563571477' style='color: #BCEA7F' >user</span>]
      @<span rel='t563571477' style='color: #BCEA7F' >user</span> = <span rel='t-4811439' style='color: #AF86C1' >User</span>.<span rel='t-1772970464' style='color: #82DBA2' >where</span>(:<span rel='t-410797461' style='color: #E58665' >id</span> =&gt; <span rel='t229118602' style='color: #B7979A' >session</span>[:<span rel='t563571477' style='color: #BCEA7F' >user</span>]).<span rel='t-1772970464' style='color: #82DBA2' >where</span><span class='string'>(&quot;status IN (&#39;active&#39;, &#39;confirmed&#39;, &#39;suspended&#39;)&quot;</span>).<span rel='t534186438' style='color: #6C7C76' >first</span>

    <span rel='t-1367128599' style='color: #79E684' >if</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-37823017' style='color: #7F6C73' >status</span> ==<span class='string'> &quot;suspended&quot;</span>
        <span rel='t229118602' style='color: #B7979A' >session</span>.<span rel='t826136558' style='color: #BCA2D0' >delete</span>(:<span rel='t563571477' style='color: #BCEA7F' >user</span>)
        <span rel='t462983441' style='color: #696C71' >session_expires_automatically</span>

        <span rel='t-1128519024' style='color: #846E9B' >redirect_to</span> :<span rel='t-1556893563' style='color: #ACA0D6' >controller</span> =&gt;<span class='string'> &quot;user&quot;</span>, :<span rel='t1814083214' style='color: #6BBEE8' >action</span> =&gt;<span class='string'> &quot;suspended&quot;</span>

        <span class='comment'># don&#39;t allow access to any auth-requiring part of the site unless</span>
        <span class='comment'># the new CTs have been seen (and accept/decline chosen).</span>
      <span rel='t-584816954' style='color: #82EFCF' >elsif</span> <span rel='t1187696471' style='color: #9B8F86' >!</span>@<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-1316139742' style='color: #65F7BF' >terms_seen</span> <span rel='t-1627742974' style='color: #E2DFF0' >and</span> <span rel='t-2147090568' style='color: #A47D66' >flash</span>[:<span rel='t-1454915345' style='color: #6BC488' >skip_terms</span>].<span rel='t-1062871906' style='color: #B19EEE' >nil</span>?
        <span rel='t-2147090568' style='color: #A47D66' >flash</span>[:<span rel='t688920349' style='color: #CD85BA' >notice</span>] = <span rel='t1754711609' style='color: #F6D4E3' >t</span><span class='string'> &#39;user.terms.you need to accept or decline&#39;</span>
        <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1870134275' style='color: #6C6993' >params</span>[:<span rel='t-630777603' style='color: #7D6C96' >referer</span>]
          <span rel='t-1128519024' style='color: #846E9B' >redirect_to</span> :<span rel='t-1556893563' style='color: #ACA0D6' >controller</span> =&gt;<span class='string'> &quot;user&quot;</span>, :<span rel='t1814083214' style='color: #6BBEE8' >action</span> =&gt;<span class='string'> &quot;terms&quot;</span>, :<span rel='t-630777603' style='color: #7D6C96' >referer</span> =&gt; <span rel='t-1870134275' style='color: #6C6993' >params</span>[:<span rel='t-630777603' style='color: #7D6C96' >referer</span>]
        <span rel='t-1440020475' style='color: #E7F5CB' >else</span>
          <span rel='t-1128519024' style='color: #846E9B' >redirect_to</span> :<span rel='t-1556893563' style='color: #ACA0D6' >controller</span> =&gt;<span class='string'> &quot;user&quot;</span>, :<span rel='t1814083214' style='color: #6BBEE8' >action</span> =&gt;<span class='string'> &quot;terms&quot;</span>, :<span rel='t-630777603' style='color: #7D6C96' >referer</span> =&gt; <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t-1739138957' style='color: #81CA64' >fullpath</span>
        <span rel='t-668885137' style='color: #D0C1E5' >end</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-584816954' style='color: #82EFCF' >elsif</span> <span rel='t229118602' style='color: #B7979A' >session</span>[:<span rel='t-1326451946' style='color: #E7E6EA' >token</span>]
      <span rel='t-1367128599' style='color: #79E684' >if</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span> = <span rel='t-4811439' style='color: #AF86C1' >User</span>.<span rel='t-1807087454' style='color: #E2E7F3' >authenticate</span>(:<span rel='t-1326451946' style='color: #E7E6EA' >token</span> =&gt; <span rel='t229118602' style='color: #B7979A' >session</span>[:<span rel='t-1326451946' style='color: #E7E6EA' >token</span>])
        <span rel='t229118602' style='color: #B7979A' >session</span>[:<span rel='t563571477' style='color: #BCEA7F' >user</span>] = @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-410797461' style='color: #E58665' >id</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t-2006233305' style='color: #A592E1' >Exception</span> =&gt; <span rel='t-1380324345' style='color: #86A68F' >ex</span>
    <span rel='t-1160199872' style='color: #EAD2F9' >logger</span>.<span rel='t1609544899' style='color: #91A6D5' >info</span><span class='string'>(&quot;Exception authorizing user: #{ex.to_s}&quot;</span>)
    <span rel='t-2028712107' style='color: #75CEEC' >reset_session</span>
    @<span rel='t563571477' style='color: #BCEA7F' >user</span> = <span rel='t-1062871906' style='color: #B19EEE' >nil</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t2031737392' style='color: #C3BC8E' >require_user</span>
    <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>
      <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t-1519084397' style='color: #AC67EC' >get</span>?
        <span rel='t-1128519024' style='color: #846E9B' >redirect_to</span> :<span rel='t-1556893563' style='color: #ACA0D6' >controller</span> =&gt;<span class='string'> &#39;user&#39;</span>, :<span rel='t1814083214' style='color: #6BBEE8' >action</span> =&gt;<span class='string'> &#39;login&#39;</span>, :<span rel='t-630777603' style='color: #7D6C96' >referer</span> =&gt; <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t-1739138957' style='color: #81CA64' >fullpath</span>
      <span rel='t-1440020475' style='color: #E7F5CB' >else</span>
        <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t2103764189' style='color: #799473' >text</span> =&gt;<span class='string'> &quot;&quot;</span>, :<span rel='t-37823017' style='color: #7F6C73' >status</span> =&gt; :<span rel='t-1464877527' style='color: #6F66E7' >forbidden</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t157149828' style='color: #686881' >require_oauth</span>
    @<span rel='t-464470748' style='color: #B8EEA6' >oauth</span> = @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-372318405' style='color: #D070DE' >access_token</span>(<span rel='t1702320236' style='color: #89D291' >OAUTH_KEY</span>) <span rel='t-1367128599' style='color: #79E684' >if</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span> <span rel='t-1627742974' style='color: #E2DFF0' >and</span> <span rel='t-777424371' style='color: #B987AD' >defined</span>? <span rel='t1702320236' style='color: #89D291' >OAUTH_KEY</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># requires the user to be logged in by the token or HTTP methods, or have an </span>
  <span class='comment'># OAuth token with the right capability. this method is a bit of a pain to call </span>
  <span class='comment'># directly, since it&#39;s cumbersome to call filters with arguments in rails. to</span>
  <span class='comment'># make it easier to read and write the code, there are some utility methods</span>
  <span class='comment'># below.</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t1150130973' style='color: #D8848B' >require_capability</span>(<span rel='t-1037833237' style='color: #E371CC' >cap</span>)
    <span class='comment'># when the current token is nil, it means the user logged in with a different</span>
    <span class='comment'># method, otherwise an OAuth token was used, which has to be checked.</span>
    <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> <span rel='t446604215' style='color: #ACDEE6' >current_token</span>.<span rel='t-1062871906' style='color: #B19EEE' >nil</span>?
      <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> <span rel='t446604215' style='color: #ACDEE6' >current_token</span>.<span rel='t-1071958923' style='color: #94ACA2' >read_attribute</span>(<span rel='t-1037833237' style='color: #E371CC' >cap</span>)
        <span rel='t868614028' style='color: #AE9685' >report_error</span><span class='string'> &quot;OAuth token doesn&#39;t have that capability.&quot;</span>, :<span rel='t-1464877527' style='color: #6F66E7' >forbidden</span>
        <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t260452950' style='color: #B2AD8A' >false</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># require the user to have cookies enabled in their browser</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t2101538306' style='color: #9EEEA6' >require_cookies</span>
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t1619255067' style='color: #95F198' >cookies</span><span class='string'>[&quot;_osm_session&quot;</span>].<span rel='t-1996962652' style='color: #C1F274' >to_s</span> ==<span class='string'> &quot;&quot;</span>
      <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1870134275' style='color: #6C6993' >params</span>[:<span rel='t-1845552986' style='color: #DACDDA' >cookie_test</span>].<span rel='t-1062871906' style='color: #B19EEE' >nil</span>?
        <span rel='t229118602' style='color: #B7979A' >session</span>[:<span rel='t-1845552986' style='color: #DACDDA' >cookie_test</span>] = <span rel='t-2069236208' style='color: #A7DFE5' >true</span>
        <span rel='t-1128519024' style='color: #846E9B' >redirect_to</span> <span rel='t-1870134275' style='color: #6C6993' >params</span>.<span rel='t760090687' style='color: #B2A6DE' >merge</span>(:<span rel='t-1845552986' style='color: #DACDDA' >cookie_test</span> =&gt;<span class='string'> &quot;true&quot;</span>)
        <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t260452950' style='color: #B2AD8A' >false</span>
      <span rel='t-1440020475' style='color: #E7F5CB' >else</span>
        <span rel='t-2147090568' style='color: #A47D66' >flash</span>.<span rel='t-614109501' style='color: #E1BC6F' >now</span>[:<span rel='t-816335712' style='color: #B5F4BC' >warning</span>] = <span rel='t1754711609' style='color: #F6D4E3' >t</span><span class='string'> &#39;application.require_cookies.cookies_needed&#39;</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-1440020475' style='color: #E7F5CB' >else</span>
      <span rel='t229118602' style='color: #B7979A' >session</span>.<span rel='t826136558' style='color: #BCA2D0' >delete</span>(:<span rel='t-1845552986' style='color: #DACDDA' >cookie_test</span>)
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'># Utility methods to make the controller filter methods easier to read and write.</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t1669152376' style='color: #C978E1' >require_allow_read_prefs</span>
    <span rel='t1150130973' style='color: #D8848B' >require_capability</span>(:<span rel='t1722120777' style='color: #8D7985' >allow_read_prefs</span>)
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-459351710' style='color: #AACCAC' >require_allow_write_prefs</span>
    <span rel='t1150130973' style='color: #D8848B' >require_capability</span>(:<span rel='t1794536578' style='color: #DB8890' >allow_write_prefs</span>)
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t2072488337' style='color: #EF9788' >require_allow_write_diary</span>
    <span rel='t1150130973' style='color: #D8848B' >require_capability</span>(:<span rel='t1930718114' style='color: #97838B' >allow_write_diary</span>)
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t639228567' style='color: #6683ED' >require_allow_write_api</span>
    <span rel='t1150130973' style='color: #D8848B' >require_capability</span>(:<span rel='t-2114226942' style='color: #93ACEC' >allow_write_api</span>)

    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-629079717' style='color: #CCECAC' >REQUIRE_TERMS_AGREED</span> <span rel='t-1627742974' style='color: #E2DFF0' >and</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-260832909' style='color: #EA7795' >terms_agreed</span>.<span rel='t-1062871906' style='color: #B19EEE' >nil</span>?
      <span rel='t868614028' style='color: #AE9685' >report_error</span><span class='string'> &quot;You must accept the contributor terms before you can edit.&quot;</span>, :<span rel='t-1464877527' style='color: #6F66E7' >forbidden</span>
      <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t260452950' style='color: #B2AD8A' >false</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-496685858' style='color: #646E95' >require_allow_read_gpx</span>
    <span rel='t1150130973' style='color: #D8848B' >require_capability</span>(:<span rel='t-1614397790' style='color: #909DD6' >allow_read_gpx</span>)
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-1677008163' style='color: #8A7B86' >require_allow_write_gpx</span>
    <span rel='t1150130973' style='color: #D8848B' >require_capability</span>(:<span rel='t-1640284962' style='color: #AB9EAD' >allow_write_gpx</span>)
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-916253449' style='color: #F4D5EF' >require_allow_write_notes</span>
    <span rel='t1150130973' style='color: #D8848B' >require_capability</span>(:<span rel='t-1285273753' style='color: #6BF4F7' >allow_write_notes</span>)
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># require that the user is a moderator, or fill out a helpful error message</span>
  <span class='comment'># and return them to the index for the controller this is wrapped from.</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t264306215' style='color: #B566E3' >require_moderator</span>
    <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t1854084117' style='color: #7275AA' >moderator</span>?
      <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t-1519084397' style='color: #AC67EC' >get</span>?
        <span rel='t-2147090568' style='color: #A47D66' >flash</span>[:<span rel='t529678419' style='color: #F3F2AF' >error</span>] = <span rel='t1754711609' style='color: #F6D4E3' >t</span><span class='string'>(&#39;application.require_moderator.not_a_moderator&#39;</span>)
        <span rel='t-1128519024' style='color: #846E9B' >redirect_to</span> :<span rel='t1814083214' style='color: #6BBEE8' >action</span> =&gt;<span class='string'> &#39;index&#39;</span>
      <span rel='t-1440020475' style='color: #E7F5CB' >else</span>
        <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t2103764189' style='color: #799473' >text</span> =&gt;<span class='string'> &quot;&quot;</span>, :<span rel='t-37823017' style='color: #7F6C73' >status</span> =&gt; :<span rel='t-1464877527' style='color: #6F66E7' >forbidden</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># sets up the @user object for use by other methods. this is mostly called</span>
  <span class='comment'># from the authorize method, but can be called elsewhere if authorisation</span>
  <span class='comment'># is optional.</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t1600884275' style='color: #77F47D' >setup_user_auth</span>
    <span class='comment'># try and setup using OAuth</span>
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1638779997' style='color: #CFA781' >not</span> <span rel='t1426465553' style='color: #8C83DF' >Authenticator</span>.<span rel='t2126294301' style='color: #D9A998' >new</span>(<span rel='t-1079867816' style='color: #DBE0DB' >self</span>, [:<span rel='t-1326451946' style='color: #E7E6EA' >token</span>]).<span rel='t244704944' style='color: #CE9CC4' >allow</span>?
      <span rel='t-1759535343' style='color: #9CA7B9' >username</span>, <span rel='t2108383388' style='color: #82ED96' >passwd</span> = <span rel='t1060489999' style='color: #91B9D5' >get_auth_data</span> <span class='comment'># parse from headers</span>
      <span class='comment'># authenticate per-scheme</span>
      <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1759535343' style='color: #9CA7B9' >username</span>.<span rel='t-1062871906' style='color: #B19EEE' >nil</span>?
        @<span rel='t563571477' style='color: #BCEA7F' >user</span> = <span rel='t-1062871906' style='color: #B19EEE' >nil</span> <span class='comment'># no authentication provided - perhaps first connect (client should retry after 401)</span>
      <span rel='t-584816954' style='color: #82EFCF' >elsif</span> <span rel='t-1759535343' style='color: #9CA7B9' >username</span> ==<span class='string'> &#39;token&#39;</span>
        @<span rel='t563571477' style='color: #BCEA7F' >user</span> = <span rel='t-4811439' style='color: #AF86C1' >User</span>.<span rel='t-1807087454' style='color: #E2E7F3' >authenticate</span>(:<span rel='t-1326451946' style='color: #E7E6EA' >token</span> =&gt; <span rel='t2108383388' style='color: #82ED96' >passwd</span>) <span class='comment'># preferred - random token for user from db, passed in basic auth</span>
      <span rel='t-1440020475' style='color: #E7F5CB' >else</span>
        @<span rel='t563571477' style='color: #BCEA7F' >user</span> = <span rel='t-4811439' style='color: #AF86C1' >User</span>.<span rel='t-1807087454' style='color: #E2E7F3' >authenticate</span>(:<span rel='t-1759535343' style='color: #9CA7B9' >username</span> =&gt; <span rel='t-1759535343' style='color: #9CA7B9' >username</span>, :<span rel='t171873240' style='color: #95E7B5' >password</span> =&gt; <span rel='t2108383388' style='color: #82ED96' >passwd</span>) <span class='comment'># basic auth</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>

    <span class='comment'># have we identified the user?</span>
    <span rel='t-1367128599' style='color: #79E684' >if</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>
      <span class='comment'># check if the user has been banned</span>
      <span rel='t-1367128599' style='color: #79E684' >if</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t771932141' style='color: #67948C' >blocks</span>.<span rel='t351358282' style='color: #E28085' >active</span>.<span rel='t51293246' style='color: #D5F493' >exists</span>?
        <span class='comment'># NOTE: need slightly more helpful message than this.</span>
        <span rel='t868614028' style='color: #AE9685' >report_error</span> <span rel='t1754711609' style='color: #F6D4E3' >t</span><span class='string'>(&#39;application.setup_user_auth.blocked&#39;</span>), :<span rel='t-1464877527' style='color: #6F66E7' >forbidden</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>

      <span class='comment'># if the user hasn&#39;t seen the contributor terms then don&#39;t</span>
      <span class='comment'># allow editing - they have to go to the web site and see</span>
      <span class='comment'># (but can decline) the CTs to continue.</span>
      <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-266603373' style='color: #70F8E9' >REQUIRE_TERMS_SEEN</span> <span rel='t-1627742974' style='color: #E2DFF0' >and</span> <span rel='t-1638779997' style='color: #CFA781' >not</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-1316139742' style='color: #65F7BF' >terms_seen</span> <span rel='t-1627742974' style='color: #E2DFF0' >and</span> <span rel='t-2147090568' style='color: #A47D66' >flash</span>[:<span rel='t-1454915345' style='color: #6BC488' >skip_terms</span>].<span rel='t-1062871906' style='color: #B19EEE' >nil</span>?
        <span rel='t-1526143748' style='color: #93F1CE' >set_locale</span>
        <span rel='t868614028' style='color: #AE9685' >report_error</span> <span rel='t1754711609' style='color: #F6D4E3' >t</span><span class='string'>(&#39;application.setup_user_auth.need_to_see_terms&#39;</span>), :<span rel='t-1464877527' style='color: #6F66E7' >forbidden</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t195767491' style='color: #ECBD6F' >authorize</span>(<span rel='t602752099' style='color: #8399CB' >realm</span><span class='string'>=&#39;Web Password&#39;</span>, <span rel='t-1236525904' style='color: #DE8ABD' >errormessage</span><span class='string'>=&quot;Couldn&#39;t authenticate you&quot;</span>) 
    <span class='comment'># make the @user object from any auth sources we have</span>
    <span rel='t1600884275' style='color: #77F47D' >setup_user_auth</span>

    <span class='comment'># handle authenticate pass/fail</span>
    <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>
      <span class='comment'># no auth, the user does not exist or the password was wrong</span>
      <span rel='t836325416' style='color: #A5717C' >response</span>.<span rel='t677078120' style='color: #9CE884' >headers</span><span class='string'>[&quot;WWW-Authenticate&quot;</span>] =<span class='string'> &quot;Basic realm=\&quot;#{realm}\&quot;&quot;</span> 
      <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t2103764189' style='color: #799473' >text</span> =&gt; <span rel='t-1236525904' style='color: #DE8ABD' >errormessage</span>, :<span rel='t-37823017' style='color: #7F6C73' >status</span> =&gt; :<span rel='t1269743378' style='color: #A36BED' >unauthorized</span>
      <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t260452950' style='color: #B2AD8A' >false</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span> 
  <span rel='t-668885137' style='color: #D0C1E5' >end</span> 

  <span class='comment'>##</span>
  <span class='comment'># to be used as a before_filter *after* authorize. this checks that</span>
  <span class='comment'># the user is a moderator and, if not, returns a forbidden error.</span>
  #
  <span class='comment'># NOTE: this isn&#39;t a very good way of doing it - it duplicates logic</span>
  <span class='comment'># from require_moderator - but what we really need to do is a fairly</span>
  <span class='comment'># drastic refactoring based on :format and respond_to? but not a </span>
  <span class='comment'># good idea to do that in this branch.</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t428421799' style='color: #EA80F4' >authorize_moderator</span>(<span rel='t-1236525904' style='color: #DE8ABD' >errormessage</span><span class='string'>=&quot;Access restricted to moderators&quot;</span>) 
    <span class='comment'># check user is a moderator</span>
    <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t1854084117' style='color: #7275AA' >moderator</span>?
      <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t2103764189' style='color: #799473' >text</span> =&gt; <span rel='t-1236525904' style='color: #DE8ABD' >errormessage</span>, :<span rel='t-37823017' style='color: #7F6C73' >status</span> =&gt; :<span rel='t-1464877527' style='color: #6F66E7' >forbidden</span>
      <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t260452950' style='color: #B2AD8A' >false</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span> 
  <span rel='t-668885137' style='color: #D0C1E5' >end</span> 

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-1642744364' style='color: #CEF98E' >check_database_readable</span>(<span rel='t768783149' style='color: #F98964' >need_api</span> = <span rel='t260452950' style='color: #B2AD8A' >false</span>)
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t887118399' style='color: #68A1C2' >database_offline</span> <span rel='t1610059808' style='color: #8D69F0' >or</span> (<span rel='t768783149' style='color: #F98964' >need_api</span> <span rel='t-1627742974' style='color: #E2DFF0' >and</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t1023938191' style='color: #8392CB' >api_offline</span>)
      <span rel='t-1128519024' style='color: #846E9B' >redirect_to</span> :<span rel='t-1556893563' style='color: #ACA0D6' >controller</span> =&gt;<span class='string'> &#39;site&#39;</span>, :<span rel='t1814083214' style='color: #6BBEE8' >action</span> =&gt;<span class='string'> &#39;offline&#39;</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t535175101' style='color: #91BF81' >check_database_writable</span>(<span rel='t768783149' style='color: #F98964' >need_api</span> = <span rel='t260452950' style='color: #B2AD8A' >false</span>)
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t887118399' style='color: #68A1C2' >database_offline</span> <span rel='t1610059808' style='color: #8D69F0' >or</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t839256253' style='color: #7E7A6D' >database_readonly</span> <span rel='t1610059808' style='color: #8D69F0' >or</span>
       (<span rel='t768783149' style='color: #F98964' >need_api</span> <span rel='t-1627742974' style='color: #E2DFF0' >and</span> (<span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t1023938191' style='color: #8392CB' >api_offline</span> <span rel='t1610059808' style='color: #8D69F0' >or</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t-250051925' style='color: #B26B85' >api_readonly</span>))
      <span rel='t-1128519024' style='color: #846E9B' >redirect_to</span> :<span rel='t-1556893563' style='color: #ACA0D6' >controller</span> =&gt;<span class='string'> &#39;site&#39;</span>, :<span rel='t1814083214' style='color: #6BBEE8' >action</span> =&gt;<span class='string'> &#39;offline&#39;</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-470116476' style='color: #D385CE' >check_api_readable</span>
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1631413865' style='color: #C5C9ED' >api_status</span> == :<span rel='t78757589' style='color: #B071D3' >offline</span>
      <span rel='t868614028' style='color: #AE9685' >report_error</span><span class='string'> &quot;Database offline for maintenance&quot;</span>, :<span rel='t1017747061' style='color: #C790C9' >service_unavailable</span>
      <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t260452950' style='color: #B2AD8A' >false</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-2036874743' style='color: #86746D' >check_api_writable</span>
    <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> <span rel='t-1631413865' style='color: #C5C9ED' >api_status</span> == :<span rel='t1768453828' style='color: #CFCBD2' >online</span>
      <span rel='t868614028' style='color: #AE9685' >report_error</span><span class='string'> &quot;Database offline for maintenance&quot;</span>, :<span rel='t1017747061' style='color: #C790C9' >service_unavailable</span>
      <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t260452950' style='color: #B2AD8A' >false</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-1795638681' style='color: #7474BE' >database_status</span>
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t887118399' style='color: #68A1C2' >database_offline</span>
      :<span rel='t78757589' style='color: #B071D3' >offline</span>
    <span rel='t-584816954' style='color: #82EFCF' >elsif</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t839256253' style='color: #7E7A6D' >database_readonly</span>
      :<span rel='t1715353813' style='color: #9EAEA8' >readonly</span>
    <span rel='t-1440020475' style='color: #E7F5CB' >else</span> 
      :<span rel='t1768453828' style='color: #CFCBD2' >online</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-1631413865' style='color: #C5C9ED' >api_status</span>
    <span rel='t-37823017' style='color: #7F6C73' >status</span> = <span rel='t-1795638681' style='color: #7474BE' >database_status</span>
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-37823017' style='color: #7F6C73' >status</span> == :<span rel='t1768453828' style='color: #CFCBD2' >online</span>
      <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t1023938191' style='color: #8392CB' >api_offline</span>
        <span rel='t-37823017' style='color: #7F6C73' >status</span> = :<span rel='t78757589' style='color: #B071D3' >offline</span>
      <span rel='t-584816954' style='color: #82EFCF' >elsif</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t-250051925' style='color: #B26B85' >api_readonly</span>
        <span rel='t-37823017' style='color: #7F6C73' >status</span> = :<span rel='t1715353813' style='color: #9EAEA8' >readonly</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t-37823017' style='color: #7F6C73' >status</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-1668083291' style='color: #75F194' >gpx_status</span>
    <span rel='t-37823017' style='color: #7F6C73' >status</span> = <span rel='t-1795638681' style='color: #7474BE' >database_status</span>
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-37823017' style='color: #7F6C73' >status</span> == :<span rel='t1768453828' style='color: #CFCBD2' >online</span>
      <span rel='t-37823017' style='color: #7F6C73' >status</span> = :<span rel='t78757589' style='color: #B071D3' >offline</span> <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t1986593770' style='color: #AF96E2' >STATUS</span> == :<span rel='t-771201155' style='color: #CE7870' >gpx_offline</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
    <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t-37823017' style='color: #7F6C73' >status</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-929702813' style='color: #8AE66D' >require_public_data</span>
    <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-271052618' style='color: #E793A0' >data_public</span>?
      <span rel='t868614028' style='color: #AE9685' >report_error</span><span class='string'> &quot;You must make your edits public to upload new data&quot;</span>, :<span rel='t-1464877527' style='color: #6F66E7' >forbidden</span>
      <span rel='t-1060062322' style='color: #C3C7F1' >return</span> <span rel='t260452950' style='color: #B2AD8A' >false</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'># Report and error to the user</span>
  <span class='comment'># (If anyone ever fixes Rails so it can set a http status &quot;reason phrase&quot;,</span>
  <span class='comment'>#  rather than only a status code and having the web engine make up a </span>
  <span class='comment'>#  phrase from that, we can also put the error message into the status</span>
  <span class='comment'>#  message. For now, rails won&#39;t let us)</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t868614028' style='color: #AE9685' >report_error</span>(<span rel='t-1689287071' style='color: #F57DE1' >message</span>, <span rel='t-37823017' style='color: #7F6C73' >status</span> = :<span rel='t-1828291330' style='color: #EBD6A0' >bad_request</span>)
    <span class='comment'># Todo: some sort of escaping of problem characters in the message</span>
    <span rel='t836325416' style='color: #A5717C' >response</span>.<span rel='t677078120' style='color: #9CE884' >headers</span><span class='string'>[&#39;Error&#39;</span>] = <span rel='t-1689287071' style='color: #F57DE1' >message</span>

    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t677078120' style='color: #9CE884' >headers</span><span class='string'>[&#39;X-Error-Format&#39;</span>] <span rel='t-1627742974' style='color: #E2DFF0' >and</span>
       <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t677078120' style='color: #9CE884' >headers</span><span class='string'>[&#39;X-Error-Format&#39;</span>].<span rel='t878011219' style='color: #6FA1D3' >downcase</span> ==<span class='string'> &quot;xml&quot;</span>
      <span rel='t824510570' style='color: #65F1D1' >result</span> = <span rel='t527894778' style='color: #E36970' >OSM</span>::<span rel='t-1085135684' style='color: #959DF9' >API</span>.<span rel='t2126294301' style='color: #D9A998' >new</span>.<span rel='t-1472951046' style='color: #F3EBD5' >get_xml_doc</span>
      <span rel='t824510570' style='color: #65F1D1' >result</span>.<span rel='t58810162' style='color: #E4A3A0' >root</span>.<span rel='t1510177277' style='color: #F894AF' >name</span> =<span class='string'> &quot;osmError&quot;</span>
      <span rel='t824510570' style='color: #65F1D1' >result</span>.<span rel='t58810162' style='color: #E4A3A0' >root</span> &lt;&lt; (<span rel='t-2092763545' style='color: #D7EDF8' >XML</span>::<span rel='t-605416427' style='color: #B7B7E3' >Node</span>.<span rel='t2126294301' style='color: #D9A998' >new</span><span class='string'>(&quot;status&quot;</span>) &lt;&lt;<span class='string'> &quot;#{Rack::Utils.status_code(status)} #{Rack::Utils::HTTP_STATUS_CODES[status]}&quot;</span>)
      <span rel='t824510570' style='color: #65F1D1' >result</span>.<span rel='t58810162' style='color: #E4A3A0' >root</span> &lt;&lt; (<span rel='t-2092763545' style='color: #D7EDF8' >XML</span>::<span rel='t-605416427' style='color: #B7B7E3' >Node</span>.<span rel='t2126294301' style='color: #D9A998' >new</span><span class='string'>(&quot;message&quot;</span>) &lt;&lt; <span rel='t-1689287071' style='color: #F57DE1' >message</span>)

      <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t2103764189' style='color: #799473' >text</span> =&gt; <span rel='t824510570' style='color: #65F1D1' >result</span>.<span rel='t-1996962652' style='color: #C1F274' >to_s</span>, :<span rel='t1628039945' style='color: #8278B9' >content_type</span> =&gt;<span class='string'> &quot;text/xml&quot;</span>
    <span rel='t-1440020475' style='color: #E7F5CB' >else</span>
      <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t2103764189' style='color: #799473' >text</span> =&gt; <span rel='t-1689287071' style='color: #F57DE1' >message</span>, :<span rel='t-37823017' style='color: #7F6C73' >status</span> =&gt; <span rel='t-37823017' style='color: #7F6C73' >status</span>, :<span rel='t1628039945' style='color: #8278B9' >content_type</span> =&gt;<span class='string'> &quot;text/plain&quot;</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-1526143748' style='color: #93F1CE' >set_locale</span>
    <span rel='t836325416' style='color: #A5717C' >response</span>.<span rel='t-765818798' style='color: #7BCEAB' >header</span><span class='string'>[&#39;Vary&#39;</span>] =<span class='string'> &#39;Accept-Language&#39;</span>

    <span rel='t-1367128599' style='color: #79E684' >if</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span> &amp;&amp; <span rel='t1187696471' style='color: #9B8F86' >!</span>@<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-823534275' style='color: #B3B16B' >languages</span>.<span rel='t2106182666' style='color: #9C96E1' >empty</span>?
      <span rel='t699599714' style='color: #E4E785' >http_accept_language</span>.<span rel='t1092056466' style='color: #A58B67' >user_preferred_languages</span> = @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-823534275' style='color: #B3B16B' >languages</span>
      <span rel='t836325416' style='color: #A5717C' >response</span>.<span rel='t-765818798' style='color: #7BCEAB' >header</span><span class='string'>[&#39;Vary&#39;</span>] =<span class='string'> &#39;*&#39;</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>

    <span rel='t779344670' style='color: #6CC3A3' >I18n</span>.<span rel='t-115665897' style='color: #C3C369' >locale</span> = <span rel='t636611687' style='color: #F0A382' >select_locale</span>

    <span rel='t-1367128599' style='color: #79E684' >if</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span> &amp;&amp; @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-823534275' style='color: #B3B16B' >languages</span>.<span rel='t2106182666' style='color: #9C96E1' >empty</span>? &amp;&amp; <span rel='t-780984089' style='color: #91BCC3' >!http_accept_language</span>.<span rel='t1092056466' style='color: #A58B67' >user_preferred_languages</span>.<span rel='t2106182666' style='color: #9C96E1' >empty</span>?
      @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-823534275' style='color: #B3B16B' >languages</span> = <span rel='t699599714' style='color: #E4E785' >http_accept_language</span>.<span rel='t1092056466' style='color: #A58B67' >user_preferred_languages</span>
      @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-1075997524' style='color: #E6ACEA' >save</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>

    <span rel='t836325416' style='color: #A5717C' >response</span>.<span rel='t677078120' style='color: #9CE884' >headers</span><span class='string'>[&#39;Content-Language&#39;</span>] = <span rel='t779344670' style='color: #6CC3A3' >I18n</span>.<span rel='t-115665897' style='color: #C3C369' >locale</span>.<span rel='t-1996962652' style='color: #C1F274' >to_s</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t636611687' style='color: #F0A382' >select_locale</span>(<span rel='t1937520998' style='color: #C4A2CE' >locales</span> = <span rel='t779344670' style='color: #6CC3A3' >I18n</span>.<span rel='t-603693287' style='color: #A77388' >available_locales</span>)
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1870134275' style='color: #6C6993' >params</span>[:<span rel='t-115665897' style='color: #C3C369' >locale</span>]
      <span rel='t699599714' style='color: #E4E785' >http_accept_language</span>.<span rel='t1092056466' style='color: #A58B67' >user_preferred_languages</span> = [ <span rel='t-1870134275' style='color: #6C6993' >params</span>[:<span rel='t-115665897' style='color: #C3C369' >locale</span>] ]
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>

    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t699599714' style='color: #E4E785' >http_accept_language</span>.<span rel='t-603235087' style='color: #C6F4C1' >compatible_language_from</span>(<span rel='t1937520998' style='color: #C4A2CE' >locales</span>).<span rel='t-1062871906' style='color: #B19EEE' >nil</span>?
      <span rel='t699599714' style='color: #E4E785' >http_accept_language</span>.<span rel='t1092056466' style='color: #A58B67' >user_preferred_languages</span> = <span rel='t699599714' style='color: #E4E785' >http_accept_language</span>.<span rel='t1092056466' style='color: #A58B67' >user_preferred_languages</span>.<span rel='t-1281965743' style='color: #CEC7B1' >collect</span> <span rel='t588912519' style='color: #807C94' >do</span> |<span rel='t-2062937073' style='color: #E3B783' >pl</span>|
        <span rel='t123683376' style='color: #E0F6B6' >pls</span> = [ <span rel='t-2062937073' style='color: #E3B783' >pl</span> ]

        <span rel='t402559951' style='color: #B979E4' >while</span> <span rel='t-2062937073' style='color: #E3B783' >pl</span>.<span rel='t-1173190137' style='color: #6EF0E5' >match</span>(/<span rel='t1489316699' style='color: #ECE7DC' >^</span>(.*)-[<span rel='t1489316699' style='color: #ECE7DC' >^</span>-]+<span rel='t-714412214' style='color: #C5F4B6' >$</span>/)
          <span rel='t123683376' style='color: #E0F6B6' >pls</span>.<span rel='t-1620467213' style='color: #71B3F0' >push</span>(<span rel='t-824372174' style='color: #D07A8D' >$1</span>) <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t1937520998' style='color: #C4A2CE' >locales</span>.<span rel='t406251991' style='color: #E097B8' >include</span>?(<span rel='t-824372174' style='color: #D07A8D' >$1</span>) <span rel='t1610059808' style='color: #8D69F0' >or</span> <span rel='t1937520998' style='color: #C4A2CE' >locales</span>.<span rel='t406251991' style='color: #E097B8' >include</span>?(<span rel='t-824372174' style='color: #D07A8D' >$1</span>.<span rel='t-633389617' style='color: #C0D16B' >to_sym</span>)
          <span rel='t-2062937073' style='color: #E3B783' >pl</span> = <span rel='t-824372174' style='color: #D07A8D' >$1</span>
        <span rel='t-668885137' style='color: #D0C1E5' >end</span>

        <span rel='t123683376' style='color: #E0F6B6' >pls</span>
      <span rel='t-668885137' style='color: #D0C1E5' >end</span>.<span rel='t-210379127' style='color: #646E89' >flatten</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>

    <span rel='t699599714' style='color: #E4E785' >http_accept_language</span>.<span rel='t-603235087' style='color: #C6F4C1' >compatible_language_from</span>(<span rel='t1937520998' style='color: #C4A2CE' >locales</span>) || <span rel='t779344670' style='color: #6CC3A3' >I18n</span>.<span rel='t1051819213' style='color: #ADA771' >default_locale</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t599010098' style='color: #F380E8' >helper_method</span> :<span rel='t636611687' style='color: #F0A382' >select_locale</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t1737264380' style='color: #A4EC9A' >api_call_handle_error</span>
    <span rel='t-269059260' style='color: #C8EAAA' >begin</span>
      <span rel='t-939991093' style='color: #D0E39C' >yield</span>
    <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t649038751' style='color: #D5F0E6' >ActiveRecord</span>::<span rel='t-53824567' style='color: #D1BB66' >RecordNotFound</span> =&gt; <span rel='t-1380324345' style='color: #86A68F' >ex</span>
      <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t2103764189' style='color: #799473' >text</span> =&gt;<span class='string'> &quot;&quot;</span>, :<span rel='t-37823017' style='color: #7F6C73' >status</span> =&gt; :<span rel='t-639924872' style='color: #679CAF' >not_found</span>
    <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t1567705747' style='color: #C6A4D3' >LibXML</span>::<span rel='t-2092763545' style='color: #D7EDF8' >XML</span>::<span rel='t701740100' style='color: #BB6797' >Error</span>, <span rel='t-235105979' style='color: #99BBF8' >ArgumentError</span> =&gt; <span rel='t-1380324345' style='color: #86A68F' >ex</span>
      <span rel='t868614028' style='color: #AE9685' >report_error</span> <span rel='t-1380324345' style='color: #86A68F' >ex</span>.<span rel='t-1689287071' style='color: #F57DE1' >message</span>, :<span rel='t-1828291330' style='color: #EBD6A0' >bad_request</span>
    <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t649038751' style='color: #D5F0E6' >ActiveRecord</span>::<span rel='t-1313944771' style='color: #E3AEBE' >RecordInvalid</span> =&gt; <span rel='t-1380324345' style='color: #86A68F' >ex</span>
      <span rel='t-1689287071' style='color: #F57DE1' >message</span> =<span class='string'> &quot;#{ex.record.class} #{ex.record.id}: &quot;</span>
      <span rel='t-1380324345' style='color: #86A68F' >ex</span>.<span rel='t2014268012' style='color: #CFCE90' >record</span>.<span rel='t-627410550' style='color: #D4C3AD' >errors</span>.<span rel='t517139053' style='color: #CBF3E9' >each</span> { |<span rel='t1838330658' style='color: #F993C9' >attr</span>,<span rel='t1132785067' style='color: #E8D084' >msg</span>| <span rel='t-1689287071' style='color: #F57DE1' >message</span> &lt;&lt;<span class='string'> &quot;#{attr}: #{msg} (#{ex.record[attr].inspect})&quot;</span> }
      <span rel='t868614028' style='color: #AE9685' >report_error</span> <span rel='t-1689287071' style='color: #F57DE1' >message</span>, :<span rel='t-1828291330' style='color: #EBD6A0' >bad_request</span>
    <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t527894778' style='color: #E36970' >OSM</span>::<span rel='t-442961266' style='color: #D9A3E5' >APIError</span> =&gt; <span rel='t-1380324345' style='color: #86A68F' >ex</span>
      <span rel='t868614028' style='color: #AE9685' >report_error</span> <span rel='t-1380324345' style='color: #86A68F' >ex</span>.<span rel='t-1689287071' style='color: #F57DE1' >message</span>, <span rel='t-1380324345' style='color: #86A68F' >ex</span>.<span rel='t-37823017' style='color: #7F6C73' >status</span>
    <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t887838952' style='color: #D578F5' >AbstractController</span>::<span rel='t206298871' style='color: #9EB2E0' >ActionNotFound</span> =&gt; <span rel='t-1380324345' style='color: #86A68F' >ex</span>
      <span rel='t190158538' style='color: #878DAD' >raise</span>
    <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t-2006233305' style='color: #A592E1' >Exception</span> =&gt; <span rel='t-1380324345' style='color: #86A68F' >ex</span>
      <span rel='t-1160199872' style='color: #EAD2F9' >logger</span>.<span rel='t1609544899' style='color: #91A6D5' >info</span><span class='string'>(&quot;API threw unexpected #{ex.class} exception: #{ex.message}&quot;</span>)
      <span rel='t-1380324345' style='color: #86A68F' >ex</span>.<span rel='t668858114' style='color: #648385' >backtrace</span>.<span rel='t517139053' style='color: #CBF3E9' >each</span> { |<span rel='t1644009670' style='color: #6FCFBB' >l</span>| <span rel='t-1160199872' style='color: #EAD2F9' >logger</span>.<span rel='t1609544899' style='color: #91A6D5' >info</span>(<span rel='t1644009670' style='color: #6FCFBB' >l</span>) }
      <span rel='t868614028' style='color: #AE9685' >report_error</span><span class='string'> &quot;#{ex.class}: #{ex.message}&quot;</span>, :<span rel='t-1777524890' style='color: #B3B3E0' >internal_server_error</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># asserts that the request method is the +method+ given as a parameter</span>
  <span class='comment'># or raises a suitable error. +method+ should be a symbol, e.g: :put or :get.</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t754124879' style='color: #A5709B' >assert_method</span>(<span rel='t-1660267520' style='color: #93AE77' >method</span>)
    <span rel='t-2096507592' style='color: #9989D9' >ok</span> = <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t-879329713' style='color: #ABF2BF' >send</span>((<span rel='t-1660267520' style='color: #93AE77' >method</span>.<span rel='t-1996962652' style='color: #C1F274' >to_s</span>.<span rel='t878011219' style='color: #6FA1D3' >downcase</span> +<span class='string'> &quot;?&quot;</span>).<span rel='t-633389617' style='color: #C0D16B' >to_sym</span>)
    <span rel='t190158538' style='color: #878DAD' >raise</span> <span rel='t527894778' style='color: #E36970' >OSM</span>::<span rel='t1105000167' style='color: #8ADC6C' >APIBadMethodError</span>.<span rel='t2126294301' style='color: #D9A998' >new</span>(<span rel='t-1660267520' style='color: #93AE77' >method</span>) <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> <span rel='t-2096507592' style='color: #9989D9' >ok</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># wrap an api call in a timeout</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-1771082864' style='color: #6B7B6D' >api_call_timeout</span>
    <span rel='t527894778' style='color: #E36970' >OSM</span>::<span rel='t2008973063' style='color: #B1D9EE' >Timer</span>.<span rel='t1664090759' style='color: #6FE399' >timeout</span>(<span rel='t1299869539' style='color: #BDC2D8' >API_TIMEOUT</span>) <span rel='t588912519' style='color: #807C94' >do</span>
      <span rel='t-939991093' style='color: #D0E39C' >yield</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t-315518183' style='color: #AF98BE' >Timeout</span>::<span rel='t701740100' style='color: #BB6797' >Error</span>
    <span rel='t190158538' style='color: #878DAD' >raise</span> <span rel='t527894778' style='color: #E36970' >OSM</span>::<span rel='t686317353' style='color: #F575F5' >APITimeoutError</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># wrap a web page in a timeout</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t330630822' style='color: #E181CD' >web_timeout</span>
    <span rel='t527894778' style='color: #E36970' >OSM</span>::<span rel='t2008973063' style='color: #B1D9EE' >Timer</span>.<span rel='t1664090759' style='color: #6FE399' >timeout</span>(<span rel='t1181027003' style='color: #B768E2' >WEB_TIMEOUT</span>) <span rel='t588912519' style='color: #807C94' >do</span>
      <span rel='t-939991093' style='color: #D0E39C' >yield</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t-863368242' style='color: #CECA95' >ActionView</span>::<span rel='t1681849319' style='color: #8BF1EB' >Template</span>::<span rel='t701740100' style='color: #BB6797' >Error</span> =&gt; <span rel='t-1380324345' style='color: #86A68F' >ex</span>
    <span rel='t-1380324345' style='color: #86A68F' >ex</span> = <span rel='t-1380324345' style='color: #86A68F' >ex</span>.<span rel='t1716209637' style='color: #E473DD' >original_exception</span>

    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1380324345' style='color: #86A68F' >ex</span>.<span rel='t886050191' style='color: #AEB17B' >is_a</span>?(<span rel='t649038751' style='color: #D5F0E6' >ActiveRecord</span>::<span rel='t556408804' style='color: #867575' >StatementInvalid</span>) <span rel='t-1627742974' style='color: #E2DFF0' >and</span> <span rel='t-1380324345' style='color: #86A68F' >ex</span>.<span rel='t-1689287071' style='color: #F57DE1' >message</span> =<span rel='t-2134155724' style='color: #9E80E1' >~</span> /<span rel='t-1750738057' style='color: #88EDD4' >execution</span> <span rel='t1606828271' style='color: #F366B7' >expired</span>/
      <span rel='t-1380324345' style='color: #86A68F' >ex</span> = <span rel='t-315518183' style='color: #AF98BE' >Timeout</span>::<span rel='t701740100' style='color: #BB6797' >Error</span>.<span rel='t2126294301' style='color: #D9A998' >new</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>

    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1380324345' style='color: #86A68F' >ex</span>.<span rel='t886050191' style='color: #AEB17B' >is_a</span>?(<span rel='t-315518183' style='color: #AF98BE' >Timeout</span>::<span rel='t701740100' style='color: #BB6797' >Error</span>)
      <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t1814083214' style='color: #6BBEE8' >action</span> =&gt;<span class='string'> &quot;timeout&quot;</span>
    <span rel='t-1440020475' style='color: #E7F5CB' >else</span>
      <span rel='t190158538' style='color: #878DAD' >raise</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t628326082' style='color: #A6C5C4' >rescue</span> <span rel='t-315518183' style='color: #AF98BE' >Timeout</span>::<span rel='t701740100' style='color: #BB6797' >Error</span>
    <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t1814083214' style='color: #6BBEE8' >action</span> =&gt;<span class='string'> &quot;timeout&quot;</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># is the requestor logged in?</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-269794232' style='color: #88DC67' >logged_in</span>?
    <span rel='t1187696471' style='color: #9B8F86' >!</span>@<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t-1062871906' style='color: #B19EEE' >nil</span>?
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># ensure that there is a &quot;this_user&quot; instance variable</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t1222514293' style='color: #B6B48B' >lookup_this_user</span>
    <span rel='t-1150546201' style='color: #F2C8DC' >unless</span> @<span rel='t-1732218289' style='color: #69EA6D' >this_user</span> = <span rel='t-4811439' style='color: #AF86C1' >User</span>.<span rel='t351358282' style='color: #E28085' >active</span>.<span rel='t-1754331436' style='color: #67F0B5' >find_by_display_name</span>(<span rel='t-1870134275' style='color: #6C6993' >params</span>[:<span rel='t-2124752935' style='color: #6DBD91' >display_name</span>])
      <span rel='t-591877' style='color: #DB8BEC' >render_unknown_user</span> <span rel='t-1870134275' style='color: #6C6993' >params</span>[:<span rel='t-2124752935' style='color: #6DBD91' >display_name</span>]
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># render a &quot;no such user&quot; page</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-591877' style='color: #DB8BEC' >render_unknown_user</span>(<span rel='t1510177277' style='color: #F894AF' >name</span>)
    @<span rel='t556024443' style='color: #D8B2AC' >title</span> = <span rel='t1754711609' style='color: #F6D4E3' >t</span><span class='string'> &quot;user.no_such_user.title&quot;</span>
    @<span rel='t-995090384' style='color: #D0C47B' >not_found_user</span> = <span rel='t1510177277' style='color: #F894AF' >name</span>

    <span rel='t-780048677' style='color: #F3AD8F' >respond_to</span> <span rel='t588912519' style='color: #807C94' >do</span> |<span rel='t697022710' style='color: #F8EAE1' >format</span>|
      <span rel='t697022710' style='color: #F8EAE1' >format</span>.<span rel='t-2077069558' style='color: #7E8B72' >html</span> { <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t-1279381823' style='color: #A5AFC6' >template</span> =&gt;<span class='string'> &quot;user/no_such_user&quot;</span>, :<span rel='t-37823017' style='color: #7F6C73' >status</span> =&gt; :<span rel='t-639924872' style='color: #679CAF' >not_found</span> }
      <span rel='t697022710' style='color: #F8EAE1' >format</span>.<span rel='t-1309464770' style='color: #8E81F3' >all</span> { <span rel='t-1857315053' style='color: #8DF2BF' >render</span> :<span rel='t2103764189' style='color: #799473' >text</span> =&gt;<span class='string'> &quot;&quot;</span>, :<span rel='t-37823017' style='color: #7F6C73' >status</span> =&gt; :<span rel='t-639924872' style='color: #679CAF' >not_found</span> }
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'>##</span>
  <span class='comment'># Unfortunately if a PUT or POST request that has a body fails to</span>
  <span class='comment'># read it then Apache will sometimes fail to return the response it</span>
  <span class='comment'># is given to the client properly, instead erroring:</span>
  #
  <span class='comment'>#   https://issues.apache.org/bugzilla/show_bug.cgi?id=44782</span>
  #
  <span class='comment'># To work round this we call rewind on the body here, which is added</span>
  <span class='comment'># as a filter, to force it to be fetched from Apache into a file.</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-1967490055' style='color: #66D7CE' >fetch_body</span>
    <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t823553238' style='color: #88D07E' >body</span>.<span rel='t1886389538' style='color: #D3B072' >rewind</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-342375265' style='color: #A6A489' >map_layout</span>
    <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t-830903566' style='color: #716695' >xhr</span>? ?<span class='string'> &#39;xhr&#39;</span> :<span class='string'> &#39;map&#39;</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t354370790' style='color: #C9B5BA' >preferred_editor</span>
    <span rel='t-1574625064' style='color: #729CD7' >editor</span> = <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1870134275' style='color: #6C6993' >params</span>[:<span rel='t-1574625064' style='color: #729CD7' >editor</span>]
      <span rel='t-1870134275' style='color: #6C6993' >params</span>[:<span rel='t-1574625064' style='color: #729CD7' >editor</span>]
    <span rel='t-584816954' style='color: #82EFCF' >elsif</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span> <span rel='t-1627742974' style='color: #E2DFF0' >and</span> @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t354370790' style='color: #C9B5BA' >preferred_editor</span>
      @<span rel='t563571477' style='color: #BCEA7F' >user</span>.<span rel='t354370790' style='color: #C9B5BA' >preferred_editor</span>
    <span rel='t-1440020475' style='color: #E7F5CB' >else</span>
      <span rel='t2055954119' style='color: #8491E4' >DEFAULT_EDITOR</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>

    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t1189925778' style='color: #E6AF9A' >env</span><span class='string'>[&#39;HTTP_USER_AGENT&#39;</span>] =<span rel='t-2134155724' style='color: #9E80E1' >~</span> /<span rel='t-836724234' style='color: #BE8A71' >MSIE</span>|<span rel='t-270669296' style='color: #6CEFCC' >Trident</span>/ <span rel='t-1627742974' style='color: #E2DFF0' >and</span> <span rel='t-1574625064' style='color: #729CD7' >editor</span> ==<span class='string'> &#39;id&#39;</span>
      <span rel='t-1574625064' style='color: #729CD7' >editor</span> =<span class='string'> &#39;potlatch2&#39;</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span>

    <span rel='t-1574625064' style='color: #729CD7' >editor</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span rel='t599010098' style='color: #F380E8' >helper_method</span> :<span rel='t354370790' style='color: #C9B5BA' >preferred_editor</span>

<span rel='t426027605' style='color: #99BA71' >private</span> 

  <span class='comment'># extract authorisation credentials from headers, returns user = nil if none</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t1060489999' style='color: #91B9D5' >get_auth_data</span> 
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t1189925778' style='color: #E6AF9A' >env</span>.<span rel='t421938322' style='color: #BCF882' >has_key</span>?<span class='string'> &#39;X-HTTP_AUTHORIZATION&#39;</span>          <span class='comment'># where mod_rewrite might have put it </span>
      <span rel='t-153489765' style='color: #F27DBA' >authdata</span> = <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t1189925778' style='color: #E6AF9A' >env</span><span class='string'>[&#39;X-HTTP_AUTHORIZATION&#39;</span>].<span rel='t-1996962652' style='color: #C1F274' >to_s</span>.<span rel='t262572102' style='color: #BEACD0' >split</span> 
    <span rel='t-584816954' style='color: #82EFCF' >elsif</span> <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t1189925778' style='color: #E6AF9A' >env</span>.<span rel='t421938322' style='color: #BCF882' >has_key</span>?<span class='string'> &#39;REDIRECT_X_HTTP_AUTHORIZATION&#39;</span>          <span class='comment'># mod_fcgi </span>
      <span rel='t-153489765' style='color: #F27DBA' >authdata</span> = <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t1189925778' style='color: #E6AF9A' >env</span><span class='string'>[&#39;REDIRECT_X_HTTP_AUTHORIZATION&#39;</span>].<span rel='t-1996962652' style='color: #C1F274' >to_s</span>.<span rel='t262572102' style='color: #BEACD0' >split</span> 
    <span rel='t-584816954' style='color: #82EFCF' >elsif</span> <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t1189925778' style='color: #E6AF9A' >env</span>.<span rel='t421938322' style='color: #BCF882' >has_key</span>?<span class='string'> &#39;HTTP_AUTHORIZATION&#39;</span>         <span class='comment'># regular location</span>
      <span rel='t-153489765' style='color: #F27DBA' >authdata</span> = <span rel='t-1533725504' style='color: #84EBAD' >request</span>.<span rel='t1189925778' style='color: #E6AF9A' >env</span><span class='string'>[&#39;HTTP_AUTHORIZATION&#39;</span>].<span rel='t-1996962652' style='color: #C1F274' >to_s</span>.<span rel='t262572102' style='color: #BEACD0' >split</span>
    <span rel='t-668885137' style='color: #D0C1E5' >end</span> 
    <span class='comment'># only basic authentication supported</span>
    <span rel='t-1367128599' style='color: #79E684' >if</span> <span rel='t-153489765' style='color: #F27DBA' >authdata</span> <span rel='t-1627742974' style='color: #E2DFF0' >and</span> <span rel='t-153489765' style='color: #F27DBA' >authdata</span>[<span rel='t-24004986' style='color: #64D5A8' >0</span>] ==<span class='string'> &#39;Basic&#39;</span> 
      <span rel='t563571477' style='color: #BCEA7F' >user</span>, <span rel='t-136453568' style='color: #EBCDDC' >pass</span> = <span rel='t476155266' style='color: #E7DCDA' >Base64</span>.<span rel='t1506895055' style='color: #9F84D2' >decode64</span>(<span rel='t-153489765' style='color: #F27DBA' >authdata</span>[<span rel='t-57531586' style='color: #7AD1D5' >1</span>]).<span rel='t262572102' style='color: #BEACD0' >split</span><span class='string'>(&#39;:&#39;</span>,<span rel='t-210525871' style='color: #A2F0A9' >2</span>)
    <span rel='t-668885137' style='color: #D0C1E5' >end</span> 
    <span rel='t-1060062322' style='color: #C3C7F1' >return</span> [<span rel='t563571477' style='color: #BCEA7F' >user</span>, <span rel='t-136453568' style='color: #EBCDDC' >pass</span>] 
  <span rel='t-668885137' style='color: #D0C1E5' >end</span> 

  <span class='comment'># used by oauth plugin to get the current user</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-2081364061' style='color: #64B5EB' >current_user</span>
    @<span rel='t563571477' style='color: #BCEA7F' >user</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'># used by oauth plugin to set the current user</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t-2081364061' style='color: #64B5EB' >current_user</span>=(<span rel='t563571477' style='color: #BCEA7F' >user</span>)
    @<span rel='t563571477' style='color: #BCEA7F' >user</span>=<span rel='t563571477' style='color: #BCEA7F' >user</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

  <span class='comment'># override to stop oauth plugin sending errors</span>
  <span rel='t-1102086700' style='color: #ACC4C7' >def</span> <span rel='t1105139471' style='color: #E8C2EC' >invalid_oauth_response</span>
  <span rel='t-668885137' style='color: #D0C1E5' >end</span>

<span rel='t-668885137' style='color: #D0C1E5' >end</span></pre><td></tr></table></body></html>